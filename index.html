<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE MORTALITY ENGINE (FUJI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        body { 
            background-color: #050505; 
            color: #39ff14; 
            font-family: 'Courier Prime', monospace; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #39ff14; }

        /* UI Elements */
        .term-border { border: 1px solid #333; }
        .term-border:hover { border-color: #39ff14; }
        .btn-cyber { 
            background: #000; border: 1px solid #39ff14; color: #39ff14; 
            text-transform: uppercase; font-weight: bold; transition: all 0.2s;
        }
        .btn-cyber:hover:not(:disabled) { background: #39ff14; color: #000; box-shadow: 0 0 10px #39ff14; }
        .btn-cyber:disabled { border-color: #555; color: #555; cursor: not-allowed; }
        
        /* Decay Filters */
        .decay-1 { filter: blur(1px) grayscale(50%); opacity: 0.9; }
        .decay-2 { filter: blur(3px) contrast(150%) hue-rotate(45deg); opacity: 0.7; }
        .decay-3 { filter: blur(6px) invert(100%); opacity: 0.4; }
        .dead { border: 1px solid #ff003c; color: #ff003c; text-decoration: line-through; }

        /* Disclaimer Box */
        .system-notice {
            background: rgba(255, 180, 0, 0.1);
            border: 1px solid #ffb400;
            color: #ffb400;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-6xl mb-4 flex flex-col md:flex-row justify-between items-center border-b-2 border-[#39ff14] pb-4">
        <div>
            <h1 class="text-3xl font-bold tracking-tighter">> MORTALITY_ENGINE <span class="text-xs text-yellow-400">[FUJI TESTNET]</span></h1>
            <p class="text-xs text-gray-500 mt-1">STATUS: <span class="animate-pulse text-red-500">DECAYING</span></p>
        </div>
        <div id="wallet-section" class="mt-4 md:mt-0 text-right">
            <button id="connectButton" class="btn-cyber px-6 py-2 rounded-none">[ CONNECT WALLET ]</button>
            <p id="accountAddress" class="text-xs mt-1 text-gray-500 hidden"></p>
        </div>
    </div>

    <div class="w-full max-w-6xl mb-8 p-4 system-notice text-xs md:text-sm font-mono leading-relaxed">
        <strong class="block mb-1">> SYSTEM PROTOCOLS:</strong>
        <ul class="list-disc pl-5 space-y-1">
            <li><strong>NETWORK:</strong> Operates exclusively on <strong>Avalanche Fuji Testnet</strong>.</li>
            <li><strong>COSTS:</strong> UPLOAD = 0.02 AVAX | HEAL = 0.01 AVAX.</li>
            <li><strong>LATENCY:</strong> The engine cycles hourly. <strong>Uploads and Heals go live at minute :00 of every hour.</strong></li>
            <li><strong>WARNING:</strong> Content ignored by the community will rot and eventually be deleted.</li>
        </ul>
    </div>

    <div class="w-full max-w-6xl mb-12 p-6 bg-[#0a0a0a] border border-[#333]">
        <div class="flex flex-col gap-4">
            <label class="text-sm text-gray-400">> UPLOAD MEMORY</label>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="postContent" placeholder="Enter text or Image URL..." 
                    class="flex-grow bg-black border border-[#555] text-white p-3 focus:outline-none focus:border-[#39ff14] font-mono">
                <button id="postButton" class="btn-cyber px-8 py-3 disabled:opacity-50">INITIATE UPLOAD</button>
            </div>
            <div id="statusMessage" class="text-xs min-h-[20px] text-gray-400"></div>
        </div>
    </div>

    <div id="gallery" class="w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full text-center py-20 text-gray-600 animate-pulse">> SYNCING WITH ENTROPY...</div>
    </div>

    <script>
        // --- CONFIGURATION (FUJI TESTNET) ---
        const RECIPIENT_ADDRESS = "0x43CAF8c948235Ed5e08608D5A7642910E3f82Fb9"; 
        const AVALANCHE_CHAIN_ID = '0xa869'; // Fuji Testnet ID
        const AVALANCHE_RPC_URL = 'https://api.avax-test.network/ext/bc/C/rpc';
        
        const COST_POST = "0.02";
        const COST_HEAL = "0.01";

        let currentAccount = null;
        let provider, signer;

        const connectBtn = document.getElementById('connectButton');
        const postBtn = document.getElementById('postButton');
        const postInput = document.getElementById('postContent');
        const statusMsg = document.getElementById('statusMessage');
        const addressDisplay = document.getElementById('accountAddress');

        connectBtn.addEventListener('click', connectWallet);
        postBtn.addEventListener('click', () => makeTransaction('post'));

        // --- WALLET FUNCTIONS ---
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') return updateStatus('MetaMask not installed.', true);
            try {
                updateStatus('Connecting...', false);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleAccountsChanged(accounts);
                await checkAndSwitchNetwork();
            } catch (error) {
                updateStatus(`Connection failed: ${error.message}`, true);
            }
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                currentAccount = null;
                connectBtn.innerText = "[ CONNECT WALLET ]";
                addressDisplay.classList.add('hidden');
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                connectBtn.innerText = "[ CONNECTED ]";
                connectBtn.disabled = true;
                addressDisplay.innerText = `USER: ${currentAccount.substring(0, 6)}...`;
                addressDisplay.classList.remove('hidden');
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                updateStatus('System Online. Ready for Input.', false);
            }
        }

        async function checkAndSwitchNetwork() {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== AVALANCHE_CHAIN_ID) {
                updateStatus('Switching to Fuji Testnet...', true);
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: AVALANCHE_CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: AVALANCHE_CHAIN_ID,
                                    chainName: 'Avalanche Fuji Testnet',
                                    rpcUrls: [AVALANCHE_RPC_URL],
                                    nativeCurrency: { name: 'Avalanche', symbol: 'AVAX', decimals: 18 },
                                    blockExplorerUrls: ['https://testnet.snowtrace.io/']
                                }],
                            });
                        } catch (addError) {
                            updateStatus('Failed to add network.', true);
                        }
                    } else {
                        updateStatus('Failed to switch network.', true);
                    }
                }
            }
        }

        async function makeTransaction(type, itemId = null) {
            if (!currentAccount) return updateStatus('Please connect wallet first.', true);
            
            // SECURITY CHECK: PREVENT SELF-TRANSFER
            if (currentAccount.toLowerCase() === RECIPIENT_ADDRESS.toLowerCase()) {
                return updateStatus("ERROR: You are logged in as the Treasury. Use a different account.", true);
            }

            let valueEth, dataHex;
            if (type === 'post') {
                const content = postInput.value.trim();
                if (!content) return updateStatus('Input cannot be empty.', true);
                valueEth = COST_POST;
                dataHex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(content));
                updateStatus('Preparing Upload...', false);
            } else if (type === 'heal') {
                valueEth = COST_HEAL;
                dataHex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(itemId));
                updateStatus(`Healing Memory...`, false);
            }

            try {
                const txParams = {
                    to: RECIPIENT_ADDRESS,
                    value: ethers.utils.parseEther(valueEth),
                    data: dataHex
                };
                const txResponse = await signer.sendTransaction(txParams);
                updateStatus(`Signal Sent! TX: ${txResponse.hash.substring(0,10)}... (Awaiting hourly sync)`, false);
                if(type === 'post') postInput.value = '';
            } catch (error) {
                console.error(error);
                updateStatus(`Error: ${error.message.substring(0, 40)}...`, true);
            }
        }

        function updateStatus(msg, isError) {
            statusMsg.innerHTML = `> ${msg}`;
            statusMsg.className = isError ? "text-red-500 text-xs mt-2" : "text-[#39ff14] text-xs mt-2";
        }

        // --- GALLERY RENDERER ---
        const glitchChars = '!@#$%^&*()_+-=[]{}|;:,.<>?/~`';
        function applyTextRot(text, entropy) {
            if (entropy < 5) return text;
            if (entropy > 23) return "01000100 01000101 01000001 01000100"; 
            let split = text.split('');
            let corruptionLevel = entropy * 2; 
            return split.map(char => {
                if (Math.random() * 100 < corruptionLevel) { return glitchChars[Math.floor(Math.random() * glitchChars.length)]; }
                return char;
            }).join('');
        }

        async function loadEntropy() {
            try {
                const response = await fetch('data/db.json');
                if (!response.ok) throw new Error("Database offline");
                const data = await response.json();
                const container = document.getElementById('gallery');
                container.innerHTML = ''; 

                data.reverse().forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'term-border p-4 bg-[#0a0a0a] relative overflow-hidden transition-all duration-300';
                    
                    let cssClass = '';
                    if (item.entropy > 5) cssClass = 'decay-1';
                    if (item.entropy > 12) cssClass = 'decay-2';
                    if (item.entropy > 18) cssClass = 'decay-3';
                    if (item.status === 'dead') cssClass = 'dead';
                    if (cssClass) div.classList.add(cssClass);

                    let contentHtml = item.type === 'image' 
                        ? `<img src="${item.content}" class="w-full h-48 object-cover mb-4 border border-[#333]" style="filter: blur(${item.entropy/2}px) grayscale(${item.entropy*4}%)" onerror="this.src='https://placehold.co/400x200/000/39ff14?text=BROKEN_LINK'">`
                        : `<div class="font-mono text-sm mb-4 min-h-[80px] break-words">${applyTextRot(item.content, item.entropy)}</div>`;

                    let btnHtml = item.status !== 'dead' 
                        ? `<button onclick="makeTransaction('heal', '${item.id}')" class="w-full border border-[#333] hover:bg-[#39ff14] hover:text-black text-[10px] py-1 transition-colors uppercase">[ HEAL MEMORY (0.01) ]</button>` 
                        : `<div class="text-center text-red-500 text-xs border border-red-900 py-1">[ LOST FOREVER ]</div>`;

                    div.innerHTML = `${contentHtml}<div class="flex justify-between items-center text-[10px] text-gray-500 mb-2 font-mono"><span>ENTROPY: ${item.entropy}/24</span><span>ID: ${item.id.substring(0,6)}</span></div>${btnHtml}`;
                    container.appendChild(div);
                });
            } catch (e) {
                document.getElementById('gallery').innerHTML = `<div class="col-span-full text-center text-red-500">> ERROR: ${e.message}</div>`;
            }
        }
        
        loadEntropy();
        if (window.ethereum) window.ethereum.on('accountsChanged', handleAccountsChanged);
    </script>
</body>
</html>
